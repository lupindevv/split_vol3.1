name: Build and Deploy to Azure VM

on:
  push:
    branches:
      - main

env:
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  VM_HOST: ${{ secrets.VM_HOST }}
  VM_USERNAME: ${{ secrets.VM_USERNAME }}

jobs:
  version:
    name: Calculate Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get latest tag
        id: get_tag
        run: |
          # Get the latest tag, or use v1.0.0 if no tags exist
          git fetch --tags
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v1.0.0")
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Current version: $LATEST_TAG"

      - name: Bump version
        id: version
        run: |
          LATEST_TAG="${{ steps.get_tag.outputs.latest_tag }}"
          
          # Remove 'v' prefix
          VERSION=${LATEST_TAG#v}
          
          # Split version into major.minor.patch
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
          
          # Increment patch version
          PATCH=$((PATCH + 1))
          
          # Create new version
          NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
          
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "âœ¨ New version: $NEW_VERSION"

      - name: Create and push new tag
        run: |
          NEW_VERSION="${{ steps.version.outputs.version }}"
          
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          git tag -a $NEW_VERSION -m "Release $NEW_VERSION"
          git push origin $NEW_VERSION
          
          echo "âœ… Created and pushed tag: $NEW_VERSION"

  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    needs: version
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/splitbill-backend:${{ needs.version.outputs.version }}
            ${{ secrets.DOCKERHUB_USERNAME }}/splitbill-backend:latest
          cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/splitbill-backend:latest
          cache-to: type=inline

      - name: Build and push frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/splitbill-frontend:${{ needs.version.outputs.version }}
            ${{ secrets.DOCKERHUB_USERNAME }}/splitbill-frontend:latest
          cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/splitbill-frontend:latest
          cache-to: type=inline

      - name: Image build summary
        run: |
          echo "ðŸŽ‰ Docker images built and pushed successfully!"
          echo "Backend: ${{ secrets.DOCKERHUB_USERNAME }}/splitbill-backend:${{ needs.version.outputs.version }}"
          echo "Frontend: ${{ secrets.DOCKERHUB_USERNAME }}/splitbill-frontend:${{ needs.version.outputs.version }}"

  deploy:
    name: Deploy to Azure VM
    runs-on: ubuntu-latest
    needs: [version, build-and-push]
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VM_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VM_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to VM
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.VM_USERNAME }}@${{ secrets.VM_HOST }} << 'EOF'
            set -e
            
            echo "ðŸš€ Starting deployment..."
            
            cd ~/splitbill-app
            
            echo "ðŸ“¥ Pulling new Docker images..."
            docker-compose pull
            
            echo "ðŸ”„ Restarting containers..."
            docker-compose up -d
            
            echo "â³ Waiting for services to start..."
            sleep 15
            
            echo "ðŸ“Š Container status:"
            docker-compose ps
            
            echo "ðŸ§¹ Cleaning up old images..."
            docker image prune -af --filter "until=24h"
            
            echo "âœ… Deployment completed successfully!"
          EOF

      - name: Health Check
        run: |
          echo "ðŸ¥ Performing health check..."
          sleep 10
          
          MAX_RETRIES=5
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.VM_HOST }} || echo "000")
            
            if [ "$RESPONSE" == "200" ] || [ "$RESPONSE" == "304" ]; then
              echo "âœ… Application is healthy! (Status: $RESPONSE)"
              exit 0
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "â³ Health check attempt $RETRY_COUNT/$MAX_RETRIES failed (Status: $RESPONSE). Retrying in 10 seconds..."
            sleep 10
          done
          
          echo "âŒ Health check failed after $MAX_RETRIES attempts"
          exit 1

      - name: Deployment Summary
        if: success()
        run: |
          echo "======================================"
          echo "ðŸŽ‰ DEPLOYMENT SUCCESSFUL!"
          echo "======================================"
          echo "ðŸ“¦ Version: ${{ needs.version.outputs.version }}"
          echo "ðŸ³ Backend: ${{ secrets.DOCKERHUB_USERNAME }}/splitbill-backend:${{ needs.version.outputs.version }}"
          echo "ðŸ³ Frontend: ${{ secrets.DOCKERHUB_USERNAME }}/splitbill-frontend:${{ needs.version.outputs.version }}"
          echo "ðŸŒ Application URL: http://${{ secrets.VM_HOST }}"
          echo "======================================"
          echo ""
          echo "âœ¨ Your application is now live!"

      - name: Deployment Failed
        if: failure()
        run: |
          echo "======================================"
          echo "âŒ DEPLOYMENT FAILED"
          echo "======================================"
          echo "Please check the logs above for errors."
          echo "You may need to:"
          echo "  1. Check VM is running and accessible"
          echo "  2. Verify SSH connection works"
          echo "  3. Check Docker and Docker Compose are installed on VM"
          echo "  4. Review container logs on the VM"
          echo "======================================"